@inherits LayoutComponentBase
@using MudBlazor.Services
@implements IAsyncDisposable

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Class="z-50">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudContainer Style="height:inherit"  MaxWidth="MaxWidth.Small" Class="d-inline-flex flex-row flex-grow-1 align-center justify-center">
            @*<MudButton Style="height:100%; min-width:70px; width:30%; color:white" Class="d-inline-flex flex-shrink-0 flex-auto ml-n10" Href="blog">
                Blog
            </MudButton>*@
            <MudPaper Elevation="0" Style="min-width:70px; width:30%" Class="d-inline-flex flex-shrink-0 flex-auto ml-n10 invisible" />
            <MudLink Style="max-height:100%" Class="d-inline-flex flex-auto align-center justify-center" Href="">
                <MudIcon Style="height:100%; min-width:105px; width:35%; color:white" Class="d-inline-flex flex-grow mb-md-n2 mb-sm-n1" 
                ViewBox="0 0 44.957 24" Icon="@Custom_Icons.TheToby" Title="TheToby" />
            </MudLink>
            <MudPaper Elevation="0" Style="min-width:70px; width:30%" Class="d-inline-flex flex-shrink-0 flex-auto invisible" />
            @*<MudButton Style="height:100%; min-width:70px; width:30%; color:white" Class="d-inline-flex flex-shrink-0 flex-auto" Href="projects">
                Projects
            </MudButton>*@
        </MudContainer>
    </MudAppBar>

    <MudMainContent>
        <!-- ToDo: remove once complete -->
        <MudAlert Severity="Severity.Error" ContentAlignment="HorizontalAlignment.Center">This website is under construction! 
            I'll be slowly adding new features as I learn Blazor. The aim of this is just to have a space in which to post blogs and host my projects.</MudAlert>
        <MudText Typo="Typo.h3" Align=Align.Center GutterBottom="true"></MudText>
        <CascadingValue Value="this">
            @Body
        </CascadingValue>
    </MudMainContent>
</MudLayout>

@code {
    public bool DrawerOpen { get; set; } = true;

    void DrawerToggle()
    {
        DrawerOpen = !DrawerOpen;
    }

    [Inject] IBreakpointService BreakpointService { get; set; } = default!;

    private Guid _subscriptionId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var args = await BreakpointService.Subscribe((breakpoint) =>
            {
                breakpoint = BreakpointService.GetBreakpoint().Result;
                if(breakpoint == Breakpoint.Xs || breakpoint == Breakpoint.Sm)
                {
                    DrawerOpen = false;
                }
                else
                {
                    DrawerOpen = true;
                }
                InvokeAsync(StateHasChanged);
            }, new ResizeOptions
                {
                    ReportRate = 50,
                    NotifyOnBreakpointOnly = true,
                });

            _subscriptionId = args.SubscriptionId;
            if (args.Breakpoint == Breakpoint.Xs || args.Breakpoint == Breakpoint.Sm)
            {
                DrawerOpen = false;
            }
            
            StateHasChanged();
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    public async ValueTask DisposeAsync() => await BreakpointService.Unsubscribe(_subscriptionId);
}